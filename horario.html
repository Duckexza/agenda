<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Agenda Semanal</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <link rel="stylesheet" href="https://duckexza.github.io/agenda/css/style.css" />
</head>
<body>
  <h2>Agenda Semanal</h2>
  <div class="container">
    <div class="inputs actions">
      <label>Twitch:
        <input type="text" id="twitch" oninput="this.value = this.value.toLowerCase()" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" />
      </label>
      <button onclick="validarLogin()"><i class="fas fa-download"></i> Carregar Agenda</button>
      <button onclick="limparAgenda()"><i class="fas fa-eraser"></i> Limpar Agenda</button>
      <button onclick="salvarAgenda()"><i class="fas fa-save"></i> Salvar</button>
    </div>
  </div>

  <div class="table-wrapper">
    <table id="agenda">
      <thead>
        <tr>
          <th>Hora</th>
          <th>Seg</th>
          <th>Ter</th>
          <th>Qua</th>
          <th>Qui</th>
          <th>Sex</th>
          <th>Sáb</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- Modais -->
  <div id="loading">Processando...</div>

  <div id="custom-prompt" role="dialog" aria-modal="true" aria-labelledby="prompt-message" tabindex="-1">
    <div id="prompt-message" style="margin-bottom:15px;"></div>
    <input id="prompt-input" type="password" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" />
    <button id="prompt-ok-btn" onclick="confirmarPrompt()">Confirmar</button>
  </div>

  <div id="custom-alert" role="alertdialog" aria-modal="true" aria-labelledby="alert-message" tabindex="-1">
    <div id="alert-message" style="margin-bottom:15px;"></div>
    <button id="alert-close-btn">Fechar</button>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyC8muc6OX32PuZNzklRIppbhBVwaOS80L0",
      authDomain: "gods-f165b.firebaseapp.com",
      projectId: "gods-f165b",
      storageBucket: "gods-f165b.appspot.com",
      messagingSenderId: "48248280273",
      appId: "1:48248280273:web:29f140663292421ac2a1f0",
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const dias = ["Seg", "Ter", "Qua", "Qui", "Sex", "Sáb"];
    const tbody = document.querySelector("#agenda tbody");
    const twitchInput = document.getElementById("twitch");

    // Criar linhas da tabela
    for (let h = 10; h <= 23; h++) {
      const tr = document.createElement("tr");
      const th = document.createElement("th");
      th.textContent = h + ":00";
      tr.appendChild(th);
      for (let d = 0; d < dias.length; d++) {
        const td = document.createElement("td");
        td.dataset.dia = dias[d];
        td.dataset.hora = h + ":00";
        td.classList.add("bloqueado");
        td.addEventListener("click", () => {
          if (td.classList.contains("verde")) {
            td.classList.remove("verde");
            td.classList.add("vermelho");
          } else if (td.classList.contains("vermelho")) {
            td.classList.remove("vermelho");
            td.classList.add("verde");
          } else {
            td.classList.add("verde");
          }
        });
        tr.appendChild(td);
      }
      tbody.appendChild(tr);
    }

    // Controles modais
    const loadingModal = document.getElementById("loading");
    const promptModal = document.getElementById("custom-prompt");
    const promptMessage = document.getElementById("prompt-message");
    const promptInput = document.getElementById("prompt-input");
    const alertModal = document.getElementById("custom-alert");
    const alertMessage = document.getElementById("alert-message");
    const alertCloseBtn = document.getElementById("alert-close-btn");

    let resolvePrompt;

    function mostrarLoading(msg = "Processando...") {
      loadingModal.textContent = msg;
      loadingModal.classList.add("show");
    }
    function esconderLoading() {
      loadingModal.classList.remove("show");
    }

    function mostrarAlerta(msg) {
      alertMessage.textContent = msg;
      alertModal.classList.add("show");
      alertCloseBtn.focus();
    }
    function esconderAlerta() {
      alertModal.classList.remove("show");
      twitchInput.focus();
    }

    // Fechar alerta com botão e com Enter
    alertCloseBtn.onclick = esconderAlerta;
    alertModal.addEventListener("keydown", (e) => {
      if (e.key === "Enter" || e.key === "Escape") {
        e.preventDefault();
        esconderAlerta();
      }
    });

    function mostrarPrompt(msg = "Digite o valor:") {
      return new Promise((resolve) => {
        promptMessage.textContent = msg;
        promptInput.value = "";
        promptModal.classList.add("show");
        promptInput.focus();

        function keyHandler(e) {
          if (e.key === "Enter") {
            e.preventDefault();
            confirmarPrompt();
          }
          if (e.key === "Escape") {
            e.preventDefault();
            fecharPrompt("");
          }
        }

        function fecharPrompt(value) {
          promptModal.classList.remove("show");
          document.removeEventListener("keydown", keyHandler);
          twitchInput.focus();
          resolve(value);
        }

        window.confirmarPrompt = () => {
          fecharPrompt(promptInput.value.trim());
        };

        document.addEventListener("keydown", keyHandler);
      });
    }

    function limparAgenda() {
      document.querySelectorAll("td").forEach((td) => td.classList.remove("verde", "vermelho"));
    }

    async function validarLogin() {
      const twitch = twitchInput.value.trim().toLowerCase();
      if (!twitch) {
        mostrarAlerta("Informe o twitch.");
        return;
      }
      mostrarLoading("Validando login...");
      try {
        const doc = await db.collection("agendas").doc(twitch).get();
        esconderLoading();
        if (!doc.exists) {
          mostrarAlerta("Twitch não encontrada.");
          return;
        }
        twitchInput.disabled = true;
        await carregarAgenda(twitch);
      } catch (e) {
        esconderLoading();
        console.error(e);
        mostrarAlerta("Erro ao validar login.");
      }
    }

    async function carregarAgenda(twitch) {
      mostrarLoading("Carregando agenda...");
      try {
        document.querySelectorAll("td").forEach((td) => td.classList.remove("bloqueado", "verde", "vermelho"));
        const doc = await db.collection("agendas").doc(twitch).get();
        if (!doc.exists) {
          mostrarAlerta("Agenda vazia.");
          return;
        }
        const agenda = doc.data();
        document.querySelectorAll("td").forEach((td) => {
          const dia = td.dataset.dia;
          const hora = td.dataset.hora;
          if (agenda[dia] && agenda[dia][hora]) {
            td.classList.add(agenda[dia][hora]);
          }
        });
      } catch (e) {
        console.error(e);
        mostrarAlerta("Erro ao carregar agenda.");
      } finally {
        esconderLoading();
      }
    }

    async function salvarAgenda() {
      const twitch = twitchInput.value.trim().toLowerCase();
      if (!twitch) {
        mostrarAlerta("Informe o twitch.");
        return;
      }
      const codigo = await mostrarPrompt("Digite o código de segurança:");
      if (!codigo) {
        mostrarAlerta("Código é obrigatório.");
        return;
      }
      mostrarLoading("Salvando agenda...");
      try {
        const agenda = {};
        document.querySelectorAll("td").forEach((td) => {
          const dia = td.dataset.dia;
          const hora = td.dataset.hora;
          let status = "vermelho";
          if (td.classList.contains("verde")) status = "verde";
          if (!agenda[dia]) agenda[dia] = {};
          agenda[dia][hora] = status;
        });
        agenda.codigo = codigo;
        await db.collection("agendas").doc(twitch).set(agenda);
        esconderLoading();
        mostrarAlerta("Agenda salva com sucesso!");
      } catch (e) {
        esconderLoading();
        console.error(e);
        mostrarAlerta("Erro ao salvar agenda.");
      }
    }

    // Enter no campo twitch chama validarLogin
    twitchInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        e.preventDefault();
        validarLogin();
      }
    });

  </script>
</body>
</html>
